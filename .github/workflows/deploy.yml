name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd /opt/delo-bot
            git pull origin main
            source venv/bin/activate
            pip install -r backend/requirements.txt --quiet

            # Backup database before migrations
            if [ -f data/deloculator.db ]; then
              cp data/deloculator.db data/deloculator.db.backup_$(date +%Y%m%d_%H%M%S)
              echo "Database backed up"
            fi

            # Run Alembic migrations
            cd backend
            alembic upgrade head
            cd ..

            sudo systemctl restart delo-bot
            echo "Deployed successfully with migrations!"
